---
title: "occCite Vignette: Downloading and Citing Biodiversity Data"
author:
- Hannah Owens
- Cory Merow
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{An overview of executing searches and generating citations using occCite}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```

# Introduction 

`occCite` is an `R`-based application for downloading, managing, and citing biodiversity data. This package is designed to facilitate querying multiple biodiversity database aggregators, tracking sources through the occurrence point cleaning process, and citing primary datasources, as well as database aggregator services.

# Setup

If you plan to query GBIF, you will need to provide them with your user login information. We have provided a dummy login below. You will need to provide actual account information. This is because you will actually be downloading *all* of the records available for the species using `occ_download()`, instead of getting results from `occ_search()`, which has a hard limit of 200,000 occurrences.

```{r login}
library(occCite);

#Creating a GBIF login
login <- GBIFLoginManager(user = "wallacetester",
                          email = "cmerow@yahoo.com",
                          pwd = "wallacetester");
```

# Performing a Simple Search

## The Basics

At its simplest, *occCite* allows you to search for occurrences for a single species. The taxonomy of the user-specified species will be verified using EOL and NCBI taxonomies.

```{r simple_search}
##Simple search
mySimpleOccCiteObject <- occQuery(x = "Protea cynaroides",
                            datasources = c("gbif", "bien"),
                            GBIFLogin = login, 
                            GBIFDownloadDirectory = system.file("extdata", package = "occCite"));
```

```{r simple_search_GBIF_results}
#GBIF search results
head(mySimpleOccCiteObject@occResults$`Protea cynaroides`$GBIF$OccurrenceTable);
```

```{r simple_search_BIEN_results}
#BIEN search results
head(mySimpleOccCiteObject@occResults$`Protea cynaroides`$BIEN$OccurrenceTable);
```

There is also a summary method for `occCite` objects with some basic information about your search.

```{r summary of simple search}
summary(mySimpleOccCiteObject)
```

## Simple Citations

After doing a search for occurrence points, you can use `occCitation()` to generate citations for primary biodiversity databases, as well as database aggregators.
**Note:** Currently, GBIF is the only aggregator for which citations are supported.

```{r simple_citation}
#Get citations
mySimpleOccCitations <- occCitation(mySimpleOccCiteObject);
```
```{r show_simple_citations}
cat(paste(mySimpleOccCitations$Citation, sep = ""), sep = "\n");
```

## Simple Taxonomic Rectification

In the simplest of searches, such as the one above, the taxonomy of your input species name is automatically rectified through the `occCite` function `studyTaxonList()` using `gnr_resolve()` from the `taxize` `R` package. If you would like to change the source of the taxonomy being used to rectify your species names, you can specify as many taxonomic repositories as you like from the Global Names Index (GNI). The complete list of GNI repositories can be found [here](http://gni.globalnames.org/data_sources). 

`studyTaxonList()` chooses the taxonomic names closest to those being input and documents which taxonomic repositories agreed with those names. `studyTaxonList()` instantiates an `occCiteData` object the same way `occQuery()` does. This object can be passed into `occQuery()` to perform your occurrence data search.

```{r taxonomic_rectification}
#Rectify taxonomy
myTROccCiteObject <- studyTaxonList(x = "Protea cynaroides", 
                                  datasources = c("NCBI", "EOL", "ITIS"));
myTROccCiteObject@cleanedTaxonomy
```

***

# Performing a Multi-Species Search

In addition to doing a simple, single species search, you can also use `occCite` to search for and manage occurrence datasets for multiple species. You can either submit a vector of species names, or you can submit a *phylogeny!*

## occCite with a Phylogeny

Here is an example of how such a search is structured, using an unpublished phylogeny of billfishes.

```{r multispecies_search_with_phylogeny, eval=F, echo=T}
library(ape);

#Get tree
# try
treeFile <- system.file("extdata/Fish_12Tax_time_calibrated.tre", package='occCite');
tree <- read.nexus(treeFile);

#Query databases for names
myPhyOccCiteObject <- studyTaxonList(x = tree, datasources = "NCBI");

#Query GBIF for occurrence data
login <- GBIFLoginManager(user = "wallacetester",
                          email = "cmerow@yahoo.com",
                          pwd = "wallacetester");

myPhyOccCiteObject <- occQuery(x = myPhyOccCiteObject, 
                            GBIFLogin = login, 
                            datasources = "gbif",
                            GBIFDownloadDirectory = "~/Desktop");
```

```{r getting_citations_for_a_multispecies_search, eval=F, echo=T}
#Get citations
myPhyOccCitations <- occCitation(myPhyOccCiteObject);
cat(paste(myPhyOccCitations$Citation, sep = ""), sep = "\n");
```

***

# Loading data from previous GBIF searches

Querying GBIF can take quite a bit of time, especially for multiple species and/or well-known species. In this case, you may wish to access previously-downloaded datasets from your computer. Here is a simple example of how that is done.

```{r search_using_previously-downloaded_GBIF_data}
#Query databases for names
myOldOccCiteObject <- studyTaxonList(x = "Protea cynaroides", datasources = "NCBI");

#Access GBIF data from a specified download directory
##Note: you do not need a login for this.
myOldOccCiteObject <- occQuery(x = myOldOccCiteObject, 
                            datasources = "gbif",
                            GBIFDownloadDirectory = system.file("extdata/", package = "occCite"),
                            loadLocalGBIFDownload = T);
```

Here is the result. Look familiar?

```{r simple_search_loaded_GBIF_results}
#GBIF search results
head(myOldOccCiteObject@occResults$`Protea cynaroides`$GBIF$OccurrenceTable);

#The full summary
summary(myOldOccCiteObject)
```

Getting citation data works the exact same way with previously-downloaded data as it does from a fresh dataset.

```{r getting_citations_from_already-downloaded_GBIF_data}
#Get citations
myOldOccCitations <- occCitation(myOldOccCiteObject);
cat(paste(myOldOccCitations$Citation, sep = ""), sep = "\n");
```

Note that you can also load multiple species using either a vector of species names or a phylogeny (provided you have previously downloaded data for all of the species of interest), and you can load occurrences from non-GBIF datasources (e.g. BIEN) in the same query.
